---
import { getCollection } from 'astro:content';
import Layout from '../layouts/Layout.astro';
import { Image } from 'astro:assets';

export async function getStaticPaths() {
  const products = await getCollection('products');
  return products.map((product) => ({
    params: { slug: product.slug },
    props: product,
  }));
}

const { data, render } = Astro.props;
const { Content } = await render();

---
<Layout title={data.title}>
  <main class="py-16">
    <div class="max-w-5xl mx-auto px-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-12 items-start">
        
        <div class="w-full">
            <div class="swiper main-gallery rounded-lg shadow-lg mb-4">
                <div class="swiper-wrapper">
                    {data.images.map((image) => (
                        <div class="swiper-slide">
                            <a href={image.src} data-pswp-width={image.width} data-pswp-height={image.height} target="_blank" class="gallery-link">
                                <Image src={image} alt={`Image of ${data.title}`} width={800} height={800} format="webp" class="w-full h-auto" />
                            </a>
                        </div>
                    ))}
                </div>
                <div class="swiper-button-prev text-white"></div>
                <div class="swiper-button-next text-white"></div>
            </div>

            <div class="swiper thumbs-gallery h-24">
                <div class="swiper-wrapper">
                    {data.images.map((image) => (
                        <div class="swiper-slide cursor-pointer rounded-md overflow-hidden">
                            <Image src={image} alt={`Thumbnail of ${data.title}`} width={100} height={100} format="webp" class="w-full h-full object-cover" />
                        </div>
                    ))}
                </div>
            </div>
        </div>

        <div class="pt-4">
          <h1 class="font-heading text-4xl font-bold mb-4 text-brand-text">{data.title}</h1>
          
          <div class="prose max-w-none text-gray-700 mb-8">
            <Content />
          </div>

          <div id="buy-button-placeholder" class="bg-gray-100 rounded-md p-8 text-center">
             <p class="font-semibold text-gray-500">Shopify "Add to Cart" button will appear here.</p>
          </div>
          
        </div>
      </div>
    </div>
  </main>
</Layout>


<style>
  /* Keep your existing rule for width */
  .main-gallery .swiper-slide {
    width: 100% !important;
  }
  
  /* Keep your existing rule for arrow color */
  .main-gallery {
    --swiper-navigation-color: #fff;
  }

  /* Add these styles for the thumbnails */
  .thumbs-gallery .swiper-slide {
    opacity: 0.5;
    transition: opacity 0.3s ease;
  }

  .thumbs-gallery .swiper-slide-thumb-active {
    opacity: 1;
  }
</style>

<script>
  import Swiper from 'swiper';
  // Import the Thumbs module
  import { Navigation, Thumbs } from 'swiper/modules';
  import PhotoSwipeLightbox from 'photoswipe/lightbox';
  
  import 'swiper/css';
  import 'swiper/css/navigation';
  import 'swiper/css/thumbs'; // Add thumbs CSS
  import 'photoswipe/style.css';

  // Initialize the thumbnail swiper first
  const thumbsSwiper = new Swiper('.thumbs-gallery', {
    loop: true,
    spaceBetween: 10,
    slidesPerView: 4,
    freeMode: true,
    watchSlidesProgress: true,
  });

  // Initialize the main swiper
  const mainSwiper = new Swiper('.main-gallery', {
    // Use Thumbs and Navigation modules
    modules: [Navigation, Thumbs],
    loop: true,
    spaceBetween: 10,
    navigation: {
      nextEl: '.swiper-button-next',
      prevEl: '.swiper-button-prev',
    },
    // Link it to the thumbnail swiper
    thumbs: {
      swiper: thumbsSwiper,
    },
  });

  // Initialize PhotoSwipe (no changes here)
  const lightbox = new PhotoSwipeLightbox({
    gallery: '.main-gallery', // Target the main gallery for lightbox
    children: '.gallery-link',
    pswpModule: () => import('photoswipe'),
    imageClickAction: 'close',
    doubleTapAction: false,
  });

  lightbox.init();
</script>